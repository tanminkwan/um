좋습니다. 요청하신 내용을 기준으로 \*\*"Microsoft 365 + MIP 라벨링 + Proxy 중계 서버 기반의 파일 보안 처리 시스템"\*\*을 중심으로
① **기술구조 설명**, ② **PowerShell 개발 역할**, ③ **교육자료용 정리본**을 하나의 개발자 교육 콘텐츠로 구성해드리겠습니다.

---

# 📘 **MIP 기반 문서 보안 처리 아키텍처 및 PowerShell 자동화 실습 자료**

---

## 🧭 **1. 시스템 구성 개요**

### 🎯 목적

보안이 중요한 사내망 환경에서 사용자가 직접 Microsoft 365에 접근하지 않고,
\*\*중계 서버(Proxy 서버)\*\*를 통해 **문서 업로드 → MIP 라벨링 → 다운로드 → 배포** 작업을 수행함으로써
중앙에서 **정보 보호를 통제**하고 **복호화 조건을 제어**하는 구조입니다.

---

## 🧱 **2. 전체 기술 구조 (Network + API)**

```plaintext
┌──────────────┐         ┌────────────────────┐         ┌────────────────────┐
│ 사용자 PC    │───────▶│ Proxy / 중계 서버   │───────▶│ Microsoft 365       │
│ (사내망)     │        │ (인터넷 연결 가능) │        │ (Graph API, MIP 등) │
└──────────────┘         └────────────────────┘         └────────────────────┘
       ▲                        ▼                                ▲
       │ 사용자 문서 제출       │ PowerShell 스크립트 실행        │ MIP 라벨/암호화 정책 제공
       ▼                        ▼                                ▼
╔═════════════════════════════════════════════════════════════════════════╗
║                       🔐 보호 흐름 요약                                 ║
║ 1. 사용자 문서 제출 →                                                   ║
║ 2. Proxy 서버에서 문서 업로드 (Graph API)                              ║
║ 3. 문서에 MIP 라벨 부착 (암호화 포함 가능)                             ║
║ 4. 사용자 다운로드 or 외부 배포 전 복호화 조건 검증 필요               ║
╚═════════════════════════════════════════════════════════════════════════╝
```

---

## 🧩 **3. 구성요소 상세**

| 구성 요소             | 역할                                                     |
| ----------------- | ------------------------------------------------------ |
| **사용자 PC**        | 사내망에 위치. 문서를 Proxy 서버로 전송 (웹 폼, SMB, API 등으로)          |
| **Proxy 중계 서버**   | PowerShell로 Microsoft 365와 통신. 인증, 업로드, 라벨링, 다운로드 등 처리 |
| **Microsoft 365** | SharePoint/OneDrive에 파일 저장 및 MIP 기반 라벨링/암호화 정책 적용      |
| **Azure RMS**     | 암호화된 문서를 열람/복호화하는 권한 및 usage rights 발급 주체              |
| **Graph API**     | 모든 작업(API 호출) 수행 도구. 문서 업로드, 다운로드, 라벨 부착 등 지원          |
| **MIP SDK (선택)**  | Proxy에서 복호화 후 처리하거나 암호화 검증할 때 사용 가능                    |

---

## ⚙️ **4. PowerShell 개발 파트 – 역할 정의**

| 파트               | 기능                                                  |
| ---------------- | --------------------------------------------------- |
| **1. 인증 처리**     | Azure AD에 등록된 App으로 OAuth2 토큰 획득                    |
| **2. 드라이브 탐색**   | OneDrive 또는 SharePoint의 대상 문서함 위치 조회                |
| **3. 파일 업로드**    | 사용자 문서를 Microsoft 365에 업로드                          |
| **4. 라벨 부착**     | `assignSensitivityLabel` API로 MIP 라벨 적용 (암호화 포함 가능) |
| **5. 다운로드 처리**   | 보호된 파일을 다시 다운로드 (암호화된 상태 유지됨)                       |
| **6. 프록시 설정 대응** | 인터넷 접근 제한 환경에서 프록시 경유 설정 포함                         |

---

## 💻 **5. PowerShell 구성 구조**

```powershell
├── config.ps1             # 앱 인증 정보, 프록시 주소, 기본 파라미터 설정
├── auth.ps1               # Access Token 발급 함수
├── drive-utils.ps1        # Drive ID 조회 함수 (OneDrive, SharePoint 공용)
├── upload-file.ps1        # 파일 업로드 함수
├── apply-label.ps1        # MIP 라벨 부착 함수
├── download-file.ps1      # 다운로드 및 저장
└── main.ps1               # 전체 실행 흐름 통합 스크립트
```

---

## 📘 **6. 교육자료 실습 시나리오**

### 시나리오 A. 사용자가 문서를 업로드하면 자동으로 MIP 라벨 부착

```bash
.\main.ps1 `
  -TargetType OneDrive `
  -UserPrincipalName kim@contoso.com `
  -RemotePath "기밀문서/계약서.docx" `
  -LocalFile "C:\사용자문서\계약서.docx"
```

* OneDrive 대상 사용자의 드라이브에 업로드
* '기밀' 라벨을 자동 부착 (암호화 포함)
* 다운로드 파일은 암호화된 상태로 저장됨

---

## 🧠 **7. 교육 참고 포인트**

| 주제           | 핵심 포인트                                                        |
| ------------ | ------------------------------------------------------------- |
| Graph API 구조 | `https://graph.microsoft.com/v1.0/drives/{driveId}/items/...` |
| 파일 보호        | 라벨 적용 시, 사용자가 지정된 권한이 없으면 복호화 불가                              |
| 복호화 흐름       | Office 앱은 Azure RMS 토큰으로 자동 복호화, 서버 측은 MIP SDK 필요             |
| API 호출 흐름    | 인증 → 드라이브 조회 → 업로드 → 라벨 적용 → 다운로드                             |
| 라벨 적용 API    | `/assignSensitivityLabel` (Protected API로 승인 필요)              |
| 에러 핸들링       | 401 → 인증 실패, 423 → 암호화된 파일 덮어쓰기, 403 → 라벨 권한 없음               |

---

## 📦 **8. 보안 고려사항 요약**

| 구분       | 고려사항                                          |
| -------- | --------------------------------------------- |
| 인증 보안    | 앱 비밀(Client Secret)은 Key Vault 또는 환경 변수 사용 권장 |
| 라벨 권한 제한 | 조직 내 라벨 적용 가능 대상자/앱 권한 제어 필요                  |
| 감사 로그    | Proxy 서버에 라벨 적용/다운로드/업로드 로그 보관                |
| 외부 유출 방지 | MIP 라벨 + RMS 암호화 정책이 유출 방지 핵심 통제 수단           |

---

## 📚 참고 리소스

* [Microsoft Graph API Docs](https://learn.microsoft.com/en-us/graph/)
* [MIP Labeling Overview](https://learn.microsoft.com/en-us/microsoft-365/compliance/sensitivity-labels)
* [AssignSensitivityLabel API](https://learn.microsoft.com/en-us/graph/api/driveitem-assignsensitivitylabel)
* [MIP SDK](https://learn.microsoft.com/en-us/information-protection/develop/)

---

## ✅ 결론

* 이 구조는 **Proxy 장비가 Microsoft 365에 직접 연결되어 라벨링/암호화를 제어**함으로써,
  **사용자 행동은 제한하고 보안 통제는 중앙 집중화**하는 구조입니다.
* PowerShell은 그 과정에서 모든 API 호출 및 자동화를 담당하며,
  **보안 정책, MIP 통합, 업로드/다운로드 흐름의 엔진 역할**을 합니다.

---

필요하다면 이 교육자료를 PDF나 HTML 문서로 포맷팅하거나,
실제 교육 세션용 **슬라이드** / **실습 안내문**도 제작 도와드릴 수 있습니다.
어떤 형식이 필요하신지 말씀 주세요!
